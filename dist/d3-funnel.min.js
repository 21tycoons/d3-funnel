/*! d3-funnel - v0.6.9 | 2015 */
!function(t,i){"use strict";function e(t,i){var e=parseInt(t.slice(1),16),h=0>i?0:255,s=0>i?-1*i:i,a=e>>16,o=e>>8&255,n=255&e,r=16777216+65536*(Math.round((h-a)*s)+a)+256*(Math.round((h-o)*s)+o)+(Math.round((h-n)*s)+n);return"#"+r.toString(16).slice(1)}var h=function(t){this.selector=t,this.defaults={width:350,height:400,bottomWidth:1/3,bottomPinch:0,isCurved:!1,curveHeight:20,fillType:"solid",isInverted:!1,hoverEffects:!1,dynamicArea:!1,minHeight:!1,animation:!1,label:{fontSize:"14px",fill:"#fff"}}};h.prototype.draw=function(t,e){this._initialize(t,e),i.select(this.selector).selectAll("svg").remove(),this.svg=i.select(this.selector).append("svg").attr("width",this.width).attr("height",this.height),this.sectionPaths=this._makePaths(),"gradient"===this.fillType&&this._defineColorGradients(this.svg),this.isCurved&&this._drawTopOval(this.svg,this.sectionPaths),this._drawSection(0)},h.prototype._initialize=function(t,e){if(!this._isArray(t)||0===t.length||!this._isArray(t[0])||t[0].length<2)throw{name:"D3 Funnel Data Error",message:"Funnel data is not valid."};e="undefined"!=typeof e?e:{},this.data=t;var h=0,s=this._extend({},this.defaults);s.width=parseInt(i.select(this.selector).style("width"),10),s.height=parseInt(i.select(this.selector).style("height"),10);var a=Object.keys(e);for(h=0;h<a.length;h++)"label"!==a[h]&&(s[a[h]]=e[a[h]]);if("label"in e){var o,n=/fontSize|fill/;for(o in e.label)o.match(n)&&(s.label[o]=e.label[o])}this.label=s.label,s.width<=0&&(s.width=this.defaults.width),s.height<=0&&(s.height=this.defaults.height);var r=i.scale.category10();for(h=0;h<this.data.length;h++){var d=/^#([0-9a-f]{3}|[0-9a-f]{6})$/i;"2"in this.data[h]&&d.test(this.data[h][2])||(this.data[h][2]=r(h))}this.width=s.width,this.height=s.height,this.bottomWidth=s.width*s.bottomWidth,this.bottomPinch=s.bottomPinch,this.isCurved=s.isCurved,this.curveHeight=s.curveHeight,this.fillType=s.fillType,this.isInverted=s.isInverted,this.hoverEffects=s.hoverEffects,this.dynamicArea=s.dynamicArea,this.minHeight=s.minHeight,this.animation=s.animation,this.bottomLeftX=(this.width-this.bottomWidth)/2,this.dx=this.bottomPinch>0?this.bottomLeftX/(t.length-this.bottomPinch):this.bottomLeftX/t.length,this.dy=this.isCurved?(this.height-this.curveHeight)/t.length:this.height/t.length,this.onItemClick=s.onItemClick},h.prototype._makePaths=function(){var t=[],i=this.dx,e=this.dy,h=0,s=this.width,a=0;this.isInverted&&(h=this.bottomLeftX,s=this.width-this.bottomLeftX);var o=0,n=0,r=0,d=this.width/2;this.isCurved&&(a=10);var l=this.width,f=0,c=this.height*(this.width+this.bottomWidth)/2,g=2*this.height/(this.width-this.bottomWidth);if(this.minHeight!==!1){var u=this.height-this.minHeight*this.data.length;c=u*(this.width+this.bottomWidth)/2}for(var p=0,v=0,m=0;m<this.data.length;m++)p+=this._isArray(this.data[m][1])?this.data[m][1][0]:this.data[m][1];for(m=0;m<this.data.length;m++){if(v=this._isArray(this.data[m][1])?this.data[m][1][0]:this.data[m][1],this.dynamicArea){var y=v/p,b=y*c;this.minHeight!==!1&&(b+=this.minHeight*(this.width+this.bottomWidth)/2),f=Math.sqrt((g*l*l-4*b)/g),i=l/2-f/2,e=2*b/(l+f),this.isCurved&&(e-=this.curveHeight/this.data.length),l=f}this.bottomPinch>0&&(this.isInverted?(this.dynamicArea||(i=this.dx),i=m<this.bottomPinch?0:i):m>=this.data.length-this.bottomPinch&&(i=0)),o=h+i,n=s-i,r=a+e,this.isInverted&&(o=h-i,n=s+i),t.push(this.isCurved?[[h,a,"M"],[d,a+(this.curveHeight-10),"Q"],[s,a,""],[n,r,"L"],[n,r,"M"],[d,r+this.curveHeight,"Q"],[o,r,""],[h,a,"L"]]:[[h,a,"M"],[s,a,"L"],[n,r,"L"],[o,r,"L"],[h,a,"L"]]),h=o,s=n,a=r}return t},h.prototype._defineColorGradients=function(t){for(var i=t.append("defs"),h=0;h<this.data.length;h++)for(var s=this.data[h][2],a=e(s,-.25),o=i.append("linearGradient").attr({id:"gradient-"+h}),n=[[0,a],[40,s],[60,s],[100,a]],r=0;r<n.length;r++){var d=n[r];o.append("stop").attr({offset:d[0]+"%",style:"stop-color:"+d[1]})}},h.prototype._drawTopOval=function(t,i){var h=0,s=this.width,a=this.width/2;this.isInverted&&(h=this.bottomLeftX,s=this.width-this.bottomLeftX);var o=i[0],n="M"+h+","+o[0][1]+" Q"+a+","+(o[1][1]+this.curveHeight-10)+" "+s+","+o[2][1]+" M"+s+",10 Q"+a+",0 "+h+",10";t.append("path").attr("fill",e(this.data[0][2],-.4)).attr("d",n)},h.prototype._drawSection=function(t){if(t!==this.data.length){var i=this.svg.append("g"),e=this._getSectionPath(i,t);if(e.data(this._getSectionData(t)),this.animation!==!1){var h=this;e.transition().duration(this.animation).ease("linear").attr("fill",this._getColor(t)).attr("d",this._getPathDefinition(t)).each("end",function(){h._drawSection(t+1)})}else e.attr("fill",this._getColor(t)).attr("d",this._getPathDefinition(t)),this._drawSection(t+1);this.hoverEffects&&e.on("mouseover",this._onMouseOver).on("mouseout",this._onMouseOut),this.onItemClick&&e.on("click",this.onItemClick),this._addSectionLabel(i,t)}},h.prototype._getSectionPath=function(t,i){var e=t.append("path");return this.animation!==!1&&this._addBeforeTransition(e,i),e},h.prototype._addBeforeTransition=function(t,i){var e=this.sectionPaths[i],h="",s="";h=this.isCurved?"M"+e[0][0]+","+e[0][1]+" Q"+e[1][0]+","+e[1][1]+" "+e[2][0]+","+e[2][1]+" L"+e[2][0]+","+e[2][1]+" M"+e[2][0]+","+e[2][1]+" Q"+e[1][0]+","+e[1][1]+" "+e[0][0]+","+e[0][1]:"M"+e[0][0]+","+e[0][1]+" L"+e[1][0]+","+e[1][1]+" L"+e[1][0]+","+e[1][1]+" L"+e[0][0]+","+e[0][1],s=this._getColor("solid"===this.fillType?i>0?i-1:i:i),t.attr("d",h).attr("fill",s)},h.prototype._getSectionData=function(t){return[{index:t,label:this.data[t][0],value:this._isArray(this.data[t][1])?this.data[t][1][0]:this.data[t][1],formattedValue:this._isArray(this.data[t][1])?this.data[t][1][1]:this.data[t][1].toLocaleString(),baseColor:this.data[t][2],fill:this._getColor(t)}]},h.prototype._getColor=function(t){return"solid"===this.fillType?this.data[t][2]:"url(#gradient-"+t+")"},h.prototype._getPathDefinition=function(t){for(var i="",e=[],h=this.sectionPaths[t],s=0;s<h.length;s++)e=h[s],i+=e[2]+e[0]+","+e[1]+" ";return i},h.prototype._onMouseOver=function(t){i.select(this).attr("fill",e(t.baseColor,-.2))},h.prototype._onMouseOut=function(t){i.select(this).attr("fill",t.fill)},h.prototype._addSectionLabel=function(t,i){var e=i,h=this.sectionPaths[i],s=this._getSectionData(i)[0],a=s.label+": "+s.formattedValue,o=this.data[e][3]||this.label.fill,n=this.width/2,r=this.isCurved?(h[2][1]+h[3][1])/2+this.curveHeight/this.data.length:(h[1][1]+h[2][1])/2;t.append("text").text(a).attr({x:n,y:r,"text-anchor":"middle","dominant-baseline":"middle",fill:o,"pointer-events":"none"}).style("font-size",this.label.fontSize)},h.prototype._isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},h.prototype._extend=function(t,i){var e;for(e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);return t},t.D3Funnel=h}(window,d3);